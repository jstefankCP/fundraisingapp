<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shop Popcorn | City Pop Fundraising</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header>
    <h1>Shop Popcorn for Our Fundraiser!</h1>
  </header>

  <section class="fundraiser-details">
    <p><strong>Fundraising Cause:</strong> City Pop Fundraiser for Local Teams</p>
    <p><strong>Organization:</strong> City Pop Fundraising</p>
    <p class="metrics"><strong>Days Left:</strong> 12 days remaining</p>
    <p class="metrics"><strong>Amount Raised:</strong> $2,430 / $5,000 Goal</p>

    <div class="share-section">
      <p>Share this fundraiser:</p>
      <button onclick="shareLink()">Share via Link</button>
      <button onclick="shareTwitter()">Share on X</button>
      <button onclick="shareFacebook()">Share on Facebook</button>
    </div>
  </section>

  <!-- Shopify Collection Component -->
  <div id="collection-component-1761423819822"></div>

  <footer>
    Â© 2025 City Pop Fundraising. All rights reserved.
  </footer>

  <!-- Shopify Buy Button Snippet with UTM/attribute serialization -->
  <script type="text/javascript">
    (function () {
      // Function to capture URL parameters
      function getURLParameters() {
        var params = {};
        var parser = document.createElement('a');
        parser.href = window.location.href;
        var query = parser.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
          var pair = vars[i].split('=');
          if (pair[0]) { // capture all parameters
            params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
          }
        }
        return params;
      }

      var urlParams = getURLParameters();
      // Only keep our keys
      var serializedParams = ['fundraiser_id', 'organization_id', 'user_id'].map(function (key) {
        if (urlParams[key]) return key + '=' + encodeURIComponent(urlParams[key]);
        return null;
      }).filter(Boolean).join('&');
      serializedParams += serializedParams ? '&CityPopApp=true' : 'CityPopApp=true';

      var scriptURL = 'https://sdks.shopifycdn.com/buy-button/latest/buy-button-storefront.min.js';
      if (window.ShopifyBuy) {
        if (window.ShopifyBuy.UI) {
          ShopifyBuyInit();
        } else {
          loadScript();
        }
      } else {
        loadScript();
      }

      function loadScript() {
        var script = document.createElement('script');
        script.async = true;
        script.src = scriptURL;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(script);
        script.onload = ShopifyBuyInit;
      }

      function ShopifyBuyInit() {
        var client = ShopifyBuy.buildClient({
          domain: 'city-pop-fundraising.myshopify.com',
          storefrontAccessToken: 'd18a70960882c060cc472257ab67a4d3',
        });

        ShopifyBuy.UI.onReady(client).then(function (ui) {
          ui.createComponent('collection', {
            id: '456057717025',
            node: document.getElementById('collection-component-1761423819822'),
            moneyFormat: '%24%7B%7Bamount%7D%7D',
            options: {
              product: {
                styles: {},
                // Override the checkout behavior to append serialized URL parameters
                buttonDestination: function (that) {
                  that._userEvent('openCheckout');
                  that.props.tracker.track('Direct Checkout', {});
                  let checkoutWindow = that.config.cart.popup ? window.open('', 'checkout') : window;
                  const input = {
                    lineItems: [{
                      variantId: that.selectedVariant.id,
                      quantity: that.selectedQuantity
                    }]
                  };
                  that.props.client.checkout.create(input).then((checkout) => {
                    let suffix = checkout.webUrl.indexOf('?') === -1 ? '?' : '&';
                    const checkoutUrl = checkout.webUrl + suffix + serializedParams;
                    checkoutWindow.location = checkoutUrl;
                  });
                },
                text: { button: "Buy now" }
              },
              cart: {
                popup: false,
                styles: {},
                text: { total: "Subtotal", button: "Checkout" }
              }
            }
          });
        });
      }
    })();
  </script>

  <!-- Simple share logic -->
  <script>
    const shareUrl = window.location.href;
    function shareLink() { navigator.clipboard.writeText(shareUrl); alert("Fundraiser link copied!"); }
    function shareTwitter() { window.open(`https://twitter.com/intent/tweet?text=Support our fundraiser! ${encodeURIComponent(shareUrl)}`, '_blank'); }
    function shareFacebook() { window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`, '_blank'); }
  </script>
</body>
</html>

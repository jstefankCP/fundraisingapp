<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>City Pop Fundraiser</title>
<style>
  body { font-family: sans-serif; background-color: #f9f9f9; color: #333; margin:0; padding:1rem; }
  h1 { color: #0567e8; text-align:center; margin-bottom:2rem; }

  /* Fundraiser Header */
  #fundraiser-header { background:#0567e8; color:#fff; padding:1.5rem 2rem; border-radius:10px; margin-bottom:2rem; text-align:center; }
  #fundraiser-header div { margin-bottom:0.3rem; }
  #fundraiser-cause { font-size:1.2rem; font-weight:600; }
  #org-id-display, #user-id-display { font-size:1rem; font-weight:500; }
  #countdown-timer { font-size:0.95rem; }
  #progress-bar-container { background:#fff; border-radius:20px; overflow:hidden; height:20px; max-width:400px; margin:0.5rem auto; }
  #progress-bar { height:100%; width:0%; background:#66cbed; text-align:right; color:#fff; line-height:20px; font-size:0.8rem; padding-right:5px; border-radius:20px; }

  /* Product grid */
  .product-grid { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; }
  .product-item { background:#fff; border-radius:10px; padding:1rem; flex:1 1 250px; max-width:250px; box-shadow:0 2px 6px rgba(0,0,0,0.1); display:flex; flex-direction:column; align-items:center; }
  .product-item img { width:100%; height:auto; border-radius:10px; }
  .product-title { font-weight:600; margin:0.5rem 0; text-align:center; }
  .product-price { font-weight:bold; margin-bottom:0.5rem; color:#0567e8; }
  .nutrition-link { font-size:0.9rem; color:#66cbed; text-decoration:underline; margin-bottom:0.5rem; cursor:pointer; }
  .quantity-selector { display:flex; align-items:center; justify-content:center; margin-bottom:0.5rem; }
  .quantity-selector button { background:#0567e8; color:#fff; border:none; padding:0.2rem 0.6rem; cursor:pointer; border-radius:5px; margin:0 0.3rem; font-size:1rem; }
  .quantity-selector span { width:30px; text-align:center; font-weight:bold; }
  .add-to-cart-btn { background-color:#0567e8; color:#fff; border:none; padding:0.6rem 1.2rem; border-radius:25px; cursor:pointer; font-size:1rem; width:100%; margin-top:0.3rem; }
  .add-to-cart-btn:hover { background-color:#055dd1; }

  /* Slide out cart */
  #cart-slideout { position:fixed; top:0; right:-100%; width:320px; height:100%; background:#fff; box-shadow:-2px 0 6px rgba(0,0,0,0.2); transition:right 0.3s ease; padding:1rem; overflow-y:auto; z-index:1000; display:flex; flex-direction:column; }
  #cart-slideout h2 { margin-top:0; color:#0567e8; }
  #cart-slideout .continue-shopping { background:transparent; border:none; color:#0567e8; cursor:pointer; margin-bottom:1rem; font-size:0.95rem; text-align:left; }
  .cart-item { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.5rem; border-bottom:1px solid #eee; padding-bottom:0.3rem; }
  .cart-item img { width:40px; height:40px; border-radius:5px; margin-right:0.5rem; }
  .cart-item-title { flex:1; font-size:0.9rem; margin-right:0.5rem; }
  .cart-item-controls { display:flex; align-items:center; gap:0.3rem; }
  .cart-item-controls button { background:#0567e8; color:#fff; border:none; padding:0.2rem 0.6rem; cursor:pointer; border-radius:5px; }
  .trash-btn { background: none; border: none; color: #aaa; font-size: 1rem; cursor: pointer; padding: 0; line-height: 1; }
  .trash-btn:hover { color: #555; }
  #subtotal { font-weight:bold; margin:1rem 0; text-align:right; color:#0567e8; }
  .checkout-btn { background:#0567e8; color:#fff; border:none; padding:0.6rem 1.2rem; border-radius:25px; width:100%; cursor:pointer; font-size:1rem; }
  .checkout-btn:hover { background:#055dd1; }
  #cart-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:999; }

  /* Floating Cart Button (mobile only) */
  #floating-cart-btn { position: fixed; bottom: 20px; right: 20px; background-color: #66cbed; color: #fff; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 1100; }
  #floating-cart-btn .cart-count { position: absolute; top: 8px; right: 8px; background: #ff5a5f; color: #fff; border-radius: 50%; width: 20px; height: 20px; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; justify-content: center; }
  @media (max-width: 768px) {
    #floating-cart-btn { display: flex; }
    .product-grid { flex-direction: column; align-items: center; }
    .product-item { max-width: 100%; }
  }

  /* Footer link styling */
  .footer-link {
    background:none; border:none; color:#fff; text-decoration:underline; cursor:pointer; font-size:0.9rem;
  }
  .footer-link:hover {
    color:#cce6ff;
  }
</style>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- Fundraiser Header -->
<div id="fundraiser-header">
  <div id="fundraiser-cause">[Loading fundraiser...]</div>
  <div id="org-id-display">[organization_id]</div>
  <div id="user-id-display">[user_id]</div>
  <div>Ends in <span id="countdown-timer">1 day</span></div>
  <div id="progress-bar-container">
    <div id="progress-bar">$0</div>
  </div>
  <div style="font-size:0.85rem;">Raised <span id="raised-amount">$0</span> of <span id="goal-amount">$1000</span></div>
</div>

<div class="product-grid" id="product-grid"></div>

<!-- Slide-out cart -->
<div id="cart-overlay"></div>
<div id="cart-slideout">
  <button class="continue-shopping" onclick="closeCart()">‚Üê Continue Shopping</button>
  <h2>Your Cart</h2>
  <div id="cart-items"></div>
  <div id="subtotal">Subtotal: $0</div>
  <button id="checkout-btn" class="checkout-btn">Secure Checkout</button>
</div>

<!-- Floating Cart Button -->
<button id="floating-cart-btn" onclick="openCart()">
  üõí
  <span class="cart-count" id="cart-count">0</span>
</button>

<script>
/* --- Supabase Initialization --- */
const SUPABASE_URL = 'https://krjdhmpxojascmkimfru.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtyamRobXB4b2phc2Nta2ltZnJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzU0MTEsImV4cCI6MjA3MzYxMTQxMX0.DoT40NSvuNZ2_HjwNfhA2qaxmWNXA57Isf1jK43TQP8';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* --- Fundraiser Params from URL --- */
function getFundraiserParams() {
  const params = {};
  const urlParams = new URLSearchParams(window.location.search);
  ['fundraiser_id', 'organization_id', 'user_id'].forEach(key => {
    const value = urlParams.get(key);
    if (value) params[key] = value;
  });
  return params;
}
const fundraiserParams = getFundraiserParams();

// Elements to update
const fundraiserCauseEl = document.getElementById("fundraiser-cause");
const orgIdDisplay = document.getElementById("org-id-display");
const userIdDisplay = document.getElementById("user-id-display");
const progressBar = document.getElementById("progress-bar");
const raisedEl = document.getElementById("raised-amount");
const goalEl = document.getElementById("goal-amount");

// Fetch fundraiser info (name & goal_amount)
async function fetchFundraiserInfo() {
  if (!fundraiserParams.fundraiser_id) return;

  const { data: fundraiser, error: fundraiserError } = await supabaseClient
    .from('fundraisers')
    .select('name, goal_amount, organization_id, user_id')
    .eq('id', fundraiserParams.fundraiser_id)
    .single();

  if (fundraiserError) {
    console.error('Error fetching fundraiser:', fundraiserError.message);
    return;
  }

  // Update fundraiser name and goal
  fundraiserCauseEl.textContent = fundraiser.name;
  goalEl.textContent = `$${fundraiser.goal_amount}`;
  progressBar.style.width = "0%";
  progressBar.textContent = "$0";

  // Now fetch organization and user names
  fetchOrganizationName(fundraiser.organization_id);
  fetchUserName(fundraiser.user_id);
}

// Fetch organization name
async function fetchOrganizationName(orgId) {
  if (!orgId) return;

  const { data: organization, error: orgError } = await supabaseClient
    .from('organizations')
    .select('name')
    .eq('id', orgId)
    .single();

  if (orgError) {
    console.error('Error fetching organization:', orgError.message);
    return;
  }

  orgIdDisplay.textContent = organization.name;
}

// Fetch user name
async function fetchUserName(userId) {
  if (!userId) return; // safeguard

  try {
    const { data, error } = await supabaseClient
      .from('user_profiles')
      .select('first_name,last_name')
      .eq('id', userId)
      .single();

    if (error) {
      console.error("Error fetching user:", error.message);
      return;
    }

    if (data && data.first_name && data.last_name) {
      userIdDisplay.textContent = `${data.first_name} ${data.last_name}`;
    } else {
      console.warn("User data missing:", data);
      userIdDisplay.textContent = "[Name not found]";
    }
  } catch (err) {
    console.error("Unexpected error:", err);
  }
}
  
// Trigger the fetch
fetchFundraiserInfo();

/* --- Countdown Timer --- */
function updateCountdown() {
  const now = new Date();
  const diff = fundraiserData.endDate - now;
  const days = diff > 0 ? Math.ceil(diff / (1000*60*60*24)) : 0;
  countdownEl.textContent = `${days} day${days!==1?"s":""}`;
}
updateCountdown();
setInterval(updateCountdown, 1000*60*60);

/* --- Product & Cart Code --- */
const shopifyStore = "city-pop-fundraising.myshopify.com";

const products = [
  { title: "Cheese & Caramel Mix Popcorn", variantId: "47907478077729", price: 16, img:"https://cdn.shopify.com/s/files/1/0792/2191/5937/products/CheeseCaramel.png?v=1750196665" },
  { title: "White Cheddar Popcorn", variantId: "47949265207585", price: 12, img:"https://cdn.shopify.com/s/files/1/0792/2191/5937/products/WhiteCheddar.png?v=1750196654" },
  { title: "Extra Buttery Popcorn", variantId: "47946797482273", price: 12, img:"https://cdn.shopify.com/s/files/1/0792/2191/5937/products/ExtraButtery.png?v=1750196660" },
  { title: "Caramel Popcorn", variantId: "47907462676769", price: 16, img:"https://cdn.shopify.com/s/files/1/0792/2191/5937/products/Caramel_1_d6b563d0-fcd7-4ac4-9917-3da334dc2e55.png?v=1750196695" },
  { title: "Kettle Popcorn", variantId: "47971562193185", price: 12, img:"https://cdn.shopify.com/s/files/1/0792/2191/5937/products/Kettle.png?v=1750196658" },
  { title: "Jalapeno Cheddar Popcorn", variantId: "47972348264737", price: 12, img:"https://cdn.shopify.com/s/files/1/0792/2191/5937/products/JalapenoCheddar_80ea7902-a107-4113-9dd3-ca2bdb62c1f7.png?v=1750196657" },
  { title: "Cheese Popcorn", variantId: "47907469295905", price: 12, img:"https://cdn.shopify.com/s/files/1/0792/2191/5937/products/Cheese.png?v=1750196644" },
  { title: "Sea Salt & Cracked Pepper Popcorn", variantId: "47941483856161", price: 12, img:"https://cdn.shopify.com/s/files/1/0792/2191/5937/products/SeaSaltNCrackedPepper.png?v=1750196661" },
  { title: "Chocolate Drizzle Popcorn", variantId: "47930741424417", price: 20, img:"https://cdn.shopify.com/s/files/1/0792/2191/5937/products/ChocolateDrizzle.png?v=1750196667" },
  { title: "Low Salt Popcorn", variantId: "47971748217121", price: 12, img:"https://cdn.shopify.com/s/files/1/0792/2191/5937/products/LowSalt.png?v=1750196643" }
];

const cart = {};
const grid = document.getElementById("product-grid");
products.forEach((product) => {
  const div = document.createElement("div");
  div.className = "product-item";

  const img = document.createElement("img"); img.src=product.img;
  div.appendChild(img);

  const title = document.createElement("div"); title.className="product-title"; title.textContent=product.title;
  div.appendChild(title);

  const price = document.createElement("div"); price.className="product-price"; price.textContent=`$${product.price}`;
  div.appendChild(price);

  const nutrition = document.createElement("div"); nutrition.className="nutrition-link"; nutrition.textContent="Nutrition Info"; div.appendChild(nutrition);

  const qtySelector = document.createElement("div"); qtySelector.className="quantity-selector";
  const minusBtn = document.createElement("button"); minusBtn.textContent="-";
  const qtyDisplay = document.createElement("span"); qtyDisplay.textContent="1";
  const plusBtn = document.createElement("button"); plusBtn.textContent="+";
  qtySelector.appendChild(minusBtn); qtySelector.appendChild(qtyDisplay); qtySelector.appendChild(plusBtn);
  div.appendChild(qtySelector);

  let qty = 1;
  plusBtn.onclick = () => { qty++; qtyDisplay.textContent=qty; }
  minusBtn.onclick = () => { if(qty>1){qty--; qtyDisplay.textContent=qty;} }

  const addBtn = document.createElement("button"); addBtn.className="add-to-cart-btn"; addBtn.textContent="Add to Cart";
  addBtn.onclick = () => { addToCart(product, qty); qty=1; qtyDisplay.textContent="1"; }
  div.appendChild(addBtn);

  grid.appendChild(div);
});

/* --- Cart Functions --- */
const cartSlide = document.getElementById("cart-slideout");
const overlay = document.getElementById("cart-overlay");
const cartCountEl = document.getElementById("cart-count");
const cartItemsEl = document.getElementById("cart-items");
const subtotalEl = document.getElementById("subtotal");

function addToCart(product, qty){
  if(cart[product.variantId]) cart[product.variantId].qty+=qty;
  else cart[product.variantId]={product, qty};
  updateCartDisplay();
}

function updateCartDisplay(){
  cartItemsEl.innerHTML="";
  let subtotal=0;
  let count=0;
  for(const key in cart){
    const item = cart[key];
    subtotal += item.product.price*item.qty;
    count += item.qty;
    const div=document.createElement("div"); div.className="cart-item";
    div.innerHTML=`
      <img src="${item.product.img}" />
      <div class="cart-item-title">${item.product.title}</div>
      <div class="cart-item-controls">
        <button onclick="changeQty('${key}', -1)">-</button>
        <span>${item.qty}</span>
        <button onclick="changeQty('${key}',1)">+</button>
        <button class="trash-btn" onclick="removeItem('${key}')">üóëÔ∏è</button>
      </div>
    `;
    cartItemsEl.appendChild(div);
  }
  subtotalEl.textContent=`Subtotal: $${subtotal}`;
  cartCountEl.textContent=count;
}

function changeQty(key, delta){
  cart[key].qty += delta;
  if(cart[key].qty<=0) delete cart[key];
  updateCartDisplay();
}

function removeItem(key){
  delete cart[key];
  updateCartDisplay();
}

function openCart(){
  cartSlide.style.right="0";
  overlay.style.display="block";
}

function closeCart(){
  cartSlide.style.right="-100%";
  overlay.style.display="none";
}

overlay.onclick = closeCart;

/* --- Checkout Button --- */
document.getElementById("checkout-btn").onclick = () => {
  let url = "https://shop.app/checkout/79221915937/cn/hWN4XQq5bkcaRAF0sEqXJdar/en-us/shoppay?CityPopApp=true&_cs=3.AMPS&_fd=0&channel=buy_button";
  const lineItems = [];
  for(const key in cart){
    const item = cart[key];
    for(let i=0;i<item.qty;i++){
      lineItems.push(item.product.variantId);
    }
  }
  if(lineItems.length>0){
    url += "&line_items="+lineItems.join(",");
    window.location.href=url;
  } else alert("Cart is empty!");
};
</script>
</body>
</html>

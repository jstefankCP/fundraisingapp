<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>City Pop Fundraiser</title>
<style>
  body { font-family: sans-serif; background-color: #f9f9f9; color: #333; margin:0; padding:1rem; }
  h1 { color: #0567e8; text-align:center; margin-bottom:0.5rem; }
  h2 { color: #0567e8; text-align:center; margin-top:0; }
  .product-grid { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin-top:1rem; }
  .product-item { background:#fff; border-radius:10px; padding:1rem; flex:1 1 250px; max-width:250px; box-shadow:0 2px 6px rgba(0,0,0,0.1); display:flex; flex-direction:column; align-items:center; }
  .product-item img { width:100%; height:auto; border-radius:10px; }
  .product-title { font-weight:600; margin:0.5rem 0; text-align:center; }
  .product-price { font-weight:bold; margin-bottom:0.5rem; color:#0567e8; }
  .quantity-selector { display:flex; align-items:center; justify-content:center; margin-bottom:0.5rem; }
  .quantity-selector button { background:#0567e8; color:#fff; border:none; padding:0.2rem 0.6rem; cursor:pointer; border-radius:5px; margin:0 0.3rem; font-size:1rem; }
  .quantity-selector span { width:30px; text-align:center; font-weight:bold; }
  .add-to-cart-btn { background-color:#0567e8; color:#fff; border:none; padding:0.6rem 1.2rem; border-radius:25px; cursor:pointer; font-size:1rem; width:100%; margin-top:0.3rem; }
  .add-to-cart-btn:hover { background-color:#055dd1; }

  /* Slide out cart */
  #cart-slideout { position:fixed; top:0; right:-100%; width:320px; height:100%; background:#fff; box-shadow:-2px 0 6px rgba(0,0,0,0.2); transition:right 0.3s ease; padding:1rem; overflow-y:auto; z-index:1000; display:flex; flex-direction:column; }
  #cart-slideout h2 { margin-top:0; color:#0567e8; }
  #cart-slideout .continue-shopping { background:transparent; border:none; color:#0567e8; cursor:pointer; margin-bottom:1rem; font-size:0.95rem; text-align:left; }
  .cart-item { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.5rem; border-bottom:1px solid #eee; padding-bottom:0.3rem; }
  .cart-item img { width:40px; height:40px; border-radius:5px; margin-right:0.5rem; }
  .cart-item-title { flex:1; font-size:0.9rem; margin-right:0.5rem; }
  .cart-item-controls { display:flex; align-items:center; gap:0.3rem; }
  .cart-item-controls button { background:#0567e8; color:#fff; border:none; padding:0.2rem 0.6rem; cursor:pointer; border-radius:5px; }
  .trash-btn { background: none; border: none; color: #aaa; font-size: 1rem; cursor: pointer; padding: 0; line-height: 1; }
  .trash-btn:hover { color: #555; }
  #subtotal { font-weight:bold; margin:1rem 0; text-align:right; color:#0567e8; }
  .checkout-btn { background:#0567e8; color:#fff; border:none; padding:0.6rem 1.2rem; border-radius:25px; width:100%; cursor:pointer; font-size:1rem; }
  .checkout-btn:hover { background:#055dd1; }
  #cart-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:999; }

  /* Floating Cart Button (mobile only) */
  #floating-cart-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #66cbed;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 1.5rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1100;
  }
  #floating-cart-btn .cart-count {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #ff5a5f;
    color: #fff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.8rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  @media (max-width: 768px) {
    #floating-cart-btn { display: flex; }
    .product-grid { flex-direction: column; align-items: center; }
    .product-item { max-width: 100%; }
  }
</style>
</head>
<body>

<h1 id="fundraiser-header">Support Our Fundraiser!</h1>
<h2 id="fundraiser-subheader"></h2>
<p id="fundraiser-cause"></p>
<p id="fundraiser-countdown"></p>
<p id="fundraiser-closed" style="display:none;color:red;font-weight:bold;">This fundraiser has ended.</p>

<div class="product-grid" id="product-grid"></div>

<!-- Slide-out cart -->
<div id="cart-overlay"></div>
<div id="cart-slideout">
  <button class="continue-shopping" onclick="closeCart()">‚Üê Continue Shopping</button>
  <h2>Your Cart</h2>
  <div id="cart-items"></div>
  <div id="subtotal">Subtotal: $0</div>
  <button id="checkout-btn" class="checkout-btn">Secure Checkout</button>
</div>

<!-- Floating Cart Button -->
<button id="floating-cart-btn" onclick="openCart()">
  üõí
  <span class="cart-count" id="cart-count">0</span>
</button>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // 1Ô∏è‚É£ SUPABASE CONFIGURATION
  const SUPABASE_URL = "https://krjdhmpxojascmkimfru.supabase.co";
  const SUPABASE_KEY = "YOUR_PUBLIC_ANON_KEY_HERE";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // 2Ô∏è‚É£ GET URL PARAMETERS
  const params = Object.fromEntries(new URLSearchParams(window.location.search));
  console.log("URL Parameters:", params);

  // 3Ô∏è‚É£ FETCH FUNDRAISER DATA
  async function loadFundraiser() {
    if(!params.fundraiser_id) {
      document.getElementById('fundraiser-header').textContent = "Missing fundraiser ID.";
      return;
    }

    const { data: fundraiser, error } = await supabase
      .from('fundraisers')
      .select('*')
      .eq('id', params.fundraiser_id)
      .single();

    console.log("Fundraiser query result:", { fundraiser, error });

    if (error || !fundraiser) {
      document.getElementById('fundraiser-header').textContent = "Error loading fundraiser";
      return;
    }

    // Load organization
    const { data: org } = await supabase
      .from('organizations')
      .select('name')
      .eq('id', fundraiser.organization_id)
      .single();

    // Load user
    const { data: user } = await supabase
      .from('user_profiles')
      .select('first_name, last_name')
      .eq('id', fundraiser.user_id)
      .single();

    // Load orders for commission
    const { data: orders } = await supabase
      .from('fundraiser_orders')
      .select('commission_amount')
      .eq('fundraiser_id', fundraiser.id);

    const raised = orders?.reduce((sum, o) => sum + (o.commission_amount || 0), 0) || 0;
    const goal = fundraiser.goal_amount || 0;
    const progressPercent = goal > 0 ? ((raised / goal) * 100).toFixed(1) : 0;

    document.getElementById('fundraiser-header').textContent =
      `${user?.first_name || "Support"} ${user?.last_name || ""}'s Fundraiser`;
    document.getElementById('fundraiser-subheader').textContent =
      `${fundraiser.name} ‚Äî Benefiting ${org?.name || "our organization"}`;
    document.getElementById('fundraiser-cause').textContent =
      `Goal: $${goal.toLocaleString()} | Raised: $${raised.toLocaleString()} (${progressPercent}%)`;

    const now = new Date();
    const endDate = new Date(fundraiser.end_date);
    if(endDate < now){
      document.getElementById('fundraiser-closed').style.display = "block";
      document.getElementById('product-grid').style.display = "none";
    } else {
      startCountdown(endDate);
      renderProducts();
    }
  }

  // 4Ô∏è‚É£ COUNTDOWN TIMER
  function startCountdown(endDate) {
    const countdownEl = document.getElementById('fundraiser-countdown');
    function updateCountdown() {
      const now = new Date();
      const diff = endDate - now;
      if (diff <= 0) { countdownEl.textContent = "This fundraiser has ended."; return; }
      const days = Math.floor(diff / (1000*60*60*24));
      const hours = Math.floor((diff / (1000*60*60)) % 24);
      const mins = Math.floor((diff / (1000*60)) % 60);
      countdownEl.textContent = `Ends in ${days}d ${hours}h ${mins}m`;
    }
    updateCountdown();
    setInterval(updateCountdown, 60000);
  }

  // 5Ô∏è‚É£ PRODUCTS & CART
  const shopifyStore = "city-pop-fundraising.myshopify.com";
  const products = [
    { title: "Cheese & Caramel Mix Popcorn", variantId: "47907478077729", price: 16, img:"https://cdn.shopify.com/s/files/1/0792/2191/5937/products/CheeseCaramel.png?v=1750196665" },
    { title: "White Cheddar Popcorn", variantId: "47949265207585", price: 12, img:"https://cdn.shopify.com/s/files/1/0792/2191/5937/products/WhiteCheddar.png?v=1750196654" },
    { title: "Extra Buttery Popcorn", variantId: "47946797482273", price: 12, img:"https://cdn.shopify.com/s/files/1/0792/2191/5937/products/ExtraButtery.png?v=1750196660" }
    // Add the rest of your products here...
  ];

  const cart = {};

  function renderProducts() {
    const grid = document.getElementById("product-grid");
    grid.innerHTML = "";
    products.forEach(product => {
      const div = document.createElement("div"); div.className="product-item";
      div.innerHTML = `
        <img src="${product.img}" />
        <div class="product-title">${product.title}</div>
        <div class="product-price">$${product.price}</div>
        <div class="nutrition-link">Nutrition Info</div>
        <div class="quantity-selector">
          <button class="minus">-</button>
          <span class="qty">1</span>
          <button class="plus">+</button>
        </div>
        <button class="add-to-cart-btn">Add to Cart</button>
      `;
      grid.appendChild(div);

      const qtySpan = div.querySelector(".qty");
      div.querySelector(".minus").onclick = ()=>{ let q=parseInt(qtySpan.textContent); if(q>1) qtySpan.textContent=q-1; };
      div.querySelector(".plus").onclick = ()=>{ let q=parseInt(qtySpan.textContent); qtySpan.textContent=q+1; };
      div.querySelector(".nutrition-link").onclick = ()=>alert("Nutrition info placeholder");
      div.querySelector(".add-to-cart-btn").onclick = ()=>{
        const qty = parseInt(qtySpan.textContent);
        cart[product.variantId] = (cart[product.variantId]||0)+qty;
        renderCart();
        openCart();
      };
    });
  }

  // Cart functionality
  const cartSlideout = document.getElementById("cart-slideout");
  const cartOverlay = document.getElementById("cart-overlay");
  const cartItemsDiv = document.getElementById("cart-items");
  const subtotalDiv = document.getElementById("subtotal");
  const checkoutBtn = document.getElementById("checkout-btn");
  const cartCountEl = document.getElementById("cart-count");
  const floatingCartBtn = document.getElementById("floating-cart-btn");

  function openCart(){ cartSlideout.style.right="0"; cartOverlay.style.display="block"; floatingCartBtn.style.display="none"; }
  function closeCart(){ cartSlideout.style.right="-100%"; cartOverlay.style.display="none"; floatingCartBtn.style.display="flex"; }
  cartOverlay.addEventListener("click", closeCart);

  function renderCart(){
    cartItemsDiv.innerHTML=""; let subtotal=0;
    for(const [variantId, qty] of Object.entries(cart)){
      if(qty>0){
        const product = products.find(p=>p.variantId===variantId);
        subtotal += product.price*qty;
        const itemDiv = document.createElement("div"); itemDiv.className="cart-item";
        itemDiv.innerHTML=`
          <img src="${product.img}" />
          <div class="cart-item-title">${product.title}</div>
          <div class="cart-item-controls">
            <button class="minus">-</button>
            <span>${qty}</span>
            <button class="plus">+</button>
            <button class="trash-btn">x</button>
          </div>`;
        cartItemsDiv.appendChild(itemDiv);

        const controls = itemDiv.querySelector(".cart-item-controls");
        controls.querySelector(".minus").onclick=()=>{ if(cart[variantId]>1){ cart[variantId]--; renderCart(); } };
        controls.querySelector(".plus").onclick=()=>{ cart[variantId]++; renderCart(); };
        controls.querySelector(".trash-btn").onclick=()=>{ delete cart[variantId]; renderCart(); };
      }
    }
    subtotalDiv.textContent=`Subtotal: $${subtotal}`;
    const totalItems = Object.values(cart).reduce((a,b)=>a+b,0);
    cartCountEl.textContent = totalItems;
    cartCountEl.style.display = totalItems>0?"flex":"none";
  }

  checkoutBtn.onclick = ()=>{
    const items = Object.entries(cart).filter(([v,q])=>q>0);
    if(items.length===0){ alert("Add at least one product."); return; }
    const checkoutUrl = new URL(`https://${shopifyStore}/cart`);
    items.forEach(([variantId, qty])=>{ checkoutUrl.pathname += `/${variantId}:${qty}`; });
    Object.entries({...params,"City Pop App":"true"}).forEach(([key,value])=>{
      if(value) checkoutUrl.searchParams.append(`attributes[${key}]`, value);
    });
    window.location.href = checkoutUrl.toString();
  };

  // 6Ô∏è‚É£ INITIALIZE PAGE
  loadFundraiser();
</script>
</body>
</html>
